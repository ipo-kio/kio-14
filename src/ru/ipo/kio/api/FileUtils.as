package ru.ipo.kio.api {
import com.adobe.serialization.json.JSON_k;

import flash.crypto.generateRandomBytes;

import flash.events.Event;
import flash.net.FileFilter;
import flash.net.FileReference;
import flash.utils.ByteArray;

import ru.ipo.kio.base.KioBase;

/**
 * ...
 * @author Ilya
 */
public class FileUtils {

    private static const SOLUTION_FILE_NAME:String = "solution";
    private static const RESULTS_FILE_NAME:String = "results";

    public static function loadSolution(problem:KioProblem):void {
        var fr:FileReference = new FileReference();

        var loc:Object = KioApi.getLocalization(KioBase.BASE_API_ID);

        fr.browse([
            new FileFilter(loc.files.solutions, "*.kio-" + problem.id + "-" + KioBase.instance.level),
            new FileFilter(loc.files.all_files, "*.*")
        ]);
        fr.addEventListener(Event.SELECT, function(e:Event):void {
            fr.addEventListener(Event.COMPLETE, function(e:Event):void {
                var data:ByteArray = fr.data;
                var solUTF:String = data.readUTFBytes(data.length);
                try {
                    var sol:Object = JSON_k.decode(solUTF);
                    problem.loadSolution(sol.solution);

                    KioBase.instance.updateLog(sol.machine_id, sol.log);
                    KioBase.instance.log("Loaded solution@tt", [sol.save_id, sol.machine_id]);
                } catch (error:Error) {
                    //TODO show error message
                }
            });
            fr.load();
        });
    }

    public static function saveSolution(problem:KioProblem):void {
        var fr:FileReference = new FileReference();
        var sol:Object = wrapSolutionToSave(problem.solution);

        KioBase.instance.log("Saving solution@tt", [sol.save_id, sol.machine_id]);

        fr.save(JSON_k.encode(sol), SOLUTION_FILE_NAME + inventDate() + ".kio-" + problem.id + "-" + KioBase.instance.level);
    }

    private static function wrapSolutionToSave(solution:Object):Object {
        var result:Object = {
            solution: solution,
            save_id: DataUtils.convertByteArrayToString(generateRandomBytes(10)),
            machine_id: KioBase.instance.machineId,
            log: KioBase.instance.getLogger()
        };

        return result;
    }

    public static function saveAll():void {
        var fr:FileReference = new FileReference();
        var sol:Object = KioBase.instance.lsoProxy.userData;
        fr.save(JSON_k.encode(sol), RESULTS_FILE_NAME + inventDate() + ".kio-" + KioBase.instance.level);
    }

    public static function saveLog():void {
        var fr:FileReference = new FileReference();
        var log:String = 'total memory ' + KioBase.instance.lsoProxy.usedBytes + "\n";
        KioBase.instance.outputLog(function(time:Number, cmd:String, extraArgs:Array):void {
            var d:Date = new Date();
            d.setTime(time);
            log += time + ' | ' + d + ' | ' + cmd;

            if (extraArgs.length > 0)
                for each (var arg:* in extraArgs)
                    log += "|" + arg;

            log += "\n";
        });
        fr.save(log, "kio" + inventDate() + ".log");
    }

    private static function inventDate():String {
        var d:Date = new Date();
        return '-' + /*dbl(d.getMonth()) + '-' +*/ dbl(d.getDay()) + "_" + dbl(d.getHours()) + '-' + dbl(d.getMinutes()) + '-' + dbl(d.getSeconds());
    }

    private static function dbl(x:int):String {
        var s:String = '' + x;
        while (s.length < 2)
            s = '0' + s;
        return s;
    }

    public static function loadAll():void {
        var fr:FileReference = new FileReference();

        var loc:Object = KioApi.getLocalization(KioBase.BASE_API_ID);

        fr.browse([
            new FileFilter(loc.files.results, "*.kio-" + KioBase.instance.level),
            new FileFilter(loc.files.all_files, "*.*")
        ]);
        fr.addEventListener(Event.SELECT, function(e:Event):void {
            fr.addEventListener(Event.COMPLETE, function(e:Event):void {
                var data:ByteArray = fr.data;
                var solUTF:String = data.readUTFBytes(data.length);
//                try {
                    var allData:* = JSON_k.decode(solUTF);
                    KioBase.instance.loadAllData(allData);
                /*} catch (error:Error) {
                    //TODO show error message
                    trace('failed to load all data');
                }*/
            });
            fr.load();
        });
    }

}
}